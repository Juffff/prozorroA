{"version":3,"sources":["../../../server/utils/dbUtils.js"],"names":["connect","createTender","getTenderByID","listAllTenders","listTenders","setNextURI","getNextURI","Tender","mongoose","model","NextURI","db","config","host","port","name","set","tender","find","_id","then","data","length","newTender","datePublished","startDate","awardCriteria","tenderers","items","classification_ids","tenderID","title","amount","currency","status","suppliers","createdAt","Date","now","toLocaleDateString","toString","history","save","err","doc","findOne","updateTender","newDoc","console","log","oldTender","compareResults","Object","keys","tNewTender","assign","callback","tenderFilter","URI","nextURI","uri"],"mappings":"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","file":"dbUtils.js","sourcesContent":["import mongoose from 'mongoose';\nimport config from '../config/config.js';\nimport '../models/Tender';\nimport '../models/NextURI';\nimport errorHandler from '../errorHandler';\nimport compareTenders from './tendersComparator';\n\nconst Tender = mongoose.model('Tender');\nconst NextURI = mongoose.model('NextURI');\n\n\nexport function connect() {\n    const db = config.db;\n    mongoose.connect(`mongodb://${db.host}:${db.port}/${db.name}`);\n    mongoose.set('debug', true);\n\n}\n\nexport function createTender(tender) {\n    Tender.find({_id: tender._id}).then(data => {\n        if (data.length === 0) {\n            const newTender = new Tender;\n            newTender._id = tender._id;\n            newTender.name = tender.name;\n            newTender.datePublished = tender.datePublished;\n            newTender.startDate = tender.startDate;\n            newTender.awardCriteria = tender.awardCriteria;\n            newTender.tenderers = tender.tenderers;\n            newTender.items = tender.items;\n            newTender.classification_ids = tender.classification_ids;\n            newTender.tenderID = tender.tenderID;\n            newTender.title = tender.title;\n            newTender.amount = tender.amount;\n            newTender.currency = tender.currency;\n            newTender.status = tender.status;\n            newTender.suppliers = tender.suppliers;\n            newTender.createdAt = new Date(Date.now()).toLocaleDateString().toString();\n            if (!tender.history) {\n                newTender.history = {[new Date(Date.now()).toLocaleDateString().toString()]: 'Добавлен в базу'};\n            } else newTender.history = tender.history;\n            newTender.save(function (err, doc) {\n                if (err) {\n                    errorHandler(err);\n                } else {\n                    // console.log(doc);\n                }\n            });\n        } else {\n            Tender.findOne({_id: tender._id}, function (err, doc) {\n                const newTender = updateTender(data[0], tender);\n                doc._id = newTender._id;\n                doc.name = newTender.name;\n                doc.datePublished = newTender.datePublished;\n                doc.startDate = newTender.startDate;\n                doc.awardCriteria = newTender.awardCriteria;\n                doc.tenderers = newTender.tenderers;\n                doc.items = newTender.items;\n                doc.classification_ids = newTender.classification_ids;\n                doc.tenderID = newTender.tenderID;\n                doc.title = newTender.title;\n                doc.amount = newTender.amount;\n                doc.currency = newTender.currency;\n                doc.status = newTender.status;\n                doc.suppliers = newTender.suppliers;\n                doc.createdAt = newTender.createdAt;\n                doc.history = newTender.history;\n                doc.save(function (err, newDoc) {\n                    if (err) {\n                        errorHandler(err);\n                    } else {\n                         console.log(newDoc);\n                    }\n                });\n            });\n\n\n        }\n    });\n}\n\nfunction updateTender(oldTender, newTender) {\n    const compareResults = compareTenders(oldTender, newTender);\n    if (Object.keys(compareResults).length !== 0) {\n        const tNewTender = {};\n        tNewTender._id = newTender._id;\n        tNewTender.name = newTender.name;\n        tNewTender.datePublished = newTender.datePublished;\n        tNewTender.startDate = newTender.startDate;\n        tNewTender.awardCriteria = newTender.awardCriteria;\n        tNewTender.tenderers = newTender.tenderers;\n        tNewTender.items = newTender.items;\n        tNewTender.classification_ids = newTender.classification_ids;\n        tNewTender.tenderID = newTender.tenderID;\n        tNewTender.title = newTender.title;\n        tNewTender.amount = newTender.amount;\n        tNewTender.currency = newTender.currency;\n        tNewTender.status = newTender.status;\n        tNewTender.suppliers = newTender.suppliers;\n        tNewTender.createdAt = oldTender.createdAt;\n        tNewTender.history = Object.assign(oldTender.history, {[new Date(Date.now()).toLocaleDateString().toString()]: compareResults});\n        return tNewTender;\n    } else return oldTender;\n}\n\nexport function getTenderByID(tender, callback) {\n    Tender.find({_id: tender._id}).then(data => callback(data[0]));\n}\n\nexport function listAllTenders(callback) {\n    return Tender.find({}).then(data => callback(data));\n}\n\nexport function listTenders(tenderFilter, callback) {\n    Tender.find(tenderFilter).then(data => callback(data));\n}\n\nexport function setNextURI(URI) {\n    NextURI.findOne({_id: 'nextURI'}, (err, doc) => {\n        if (doc) {\n            doc.nextURI = URI;\n            doc.save((err, doc) => {\n                if (err) {\n                    errorHandler(err);\n                }\n            });\n\n        } else {\n            const uri = new NextURI;\n            uri._id = 'nextURI';\n            uri.nextURI = URI;\n            uri.save((err, doc) => {\n                if (err) {\n                    errorHandler(err);\n                }\n            });\n        }\n    })\n}\n\nexport function getNextURI(callback) {\n    NextURI.findOne({_id: 'nextURI'}, (err, doc) => {\n        if (doc) {\n            callback(doc.nextURI);\n\n        } else {\n            callback(false);\n        }\n    });\n}"]}