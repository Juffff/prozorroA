{"version":3,"sources":["../../../server/utils/dbUtils.js"],"names":["connect","createTender","getTenderByID","listAllTenders","listTenders","setNextURI","getNextURI","Tender","mongoose","model","NextURI","db","config","Promise","global","host","port","name","useMongoClient","tender","find","_id","then","data","length","newTender","datePublished","startDate","awardCriteria","tenderers","items","classification_ids","tenderID","title","amount","currency","status","suppliers","createdAt","Date","now","toLocaleDateString","toString","date","day","time","toLocaleTimeString","history","save","err","doc","findOne","updateTender","newDoc","console","log","oldTender","compareResults","Object","keys","tNewTender","assign","callback","tenderFilter","URI","nextURI","uri"],"mappings":"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","file":"dbUtils.js","sourcesContent":["import mongoose from 'mongoose';\nimport config from '../config/config.js';\nimport '../models/Tender';\nimport '../models/NextURI';\nimport errorHandler from '../errorHandler';\nimport compareTenders from './tendersComparator';\n\nconst Tender = mongoose.model('Tender');\nconst NextURI = mongoose.model('NextURI');\n\n\nexport function connect() {\n    const db = config.db;\n    mongoose.Promise = global.Promise;\n    mongoose.connect(`mongodb://${db.host}:${db.port}/${db.name}`, { useMongoClient: true });\n    //mongoose.set('debug', true);\n}\n\nexport function createTender(tender) {\n    Tender.find({_id: tender._id}).then(data => {\n        if (data.length === 0) {\n            const newTender = new Tender;\n            newTender._id = tender._id;\n            newTender.name = tender.name;\n            newTender.datePublished = tender.datePublished;\n            newTender.startDate = tender.startDate;\n            newTender.awardCriteria = tender.awardCriteria;\n            newTender.tenderers = tender.tenderers;\n            newTender.items = tender.items;\n            newTender.classification_ids = tender.classification_ids;\n            newTender.tenderID = tender.tenderID;\n            newTender.title = tender.title;\n            newTender.amount = tender.amount;\n            newTender.currency = tender.currency;\n            newTender.status = tender.status;\n            newTender.suppliers = tender.suppliers;\n            newTender.createdAt = new Date(Date.now()).toLocaleDateString().toString();\n            const date = new Date(Date.now());\n            const day = date.toLocaleDateString();\n            const time = date.toLocaleTimeString();\n            if (!tender.history) {\n                newTender.history = {[`${day}:${time}`]: 'Тендер добавлен в базу'};\n            } else newTender.history = tender.history;\n            newTender.save(function (err, doc) {\n                if (err) {\n                    errorHandler(err);\n                } else {\n                    // console.log(doc);\n                }\n            });\n        } else {\n            Tender.findOne({_id: tender._id}, function (err, doc) {\n                const newTender = updateTender(data[0], tender);\n                doc._id = newTender._id;\n                doc.name = newTender.name;\n                doc.datePublished = newTender.datePublished;\n                doc.startDate = newTender.startDate;\n                doc.awardCriteria = newTender.awardCriteria;\n                doc.tenderers = newTender.tenderers;\n                doc.items = newTender.items;\n                doc.classification_ids = newTender.classification_ids;\n                doc.tenderID = newTender.tenderID;\n                doc.title = newTender.title;\n                doc.amount = newTender.amount;\n                doc.currency = newTender.currency;\n                doc.status = newTender.status;\n                doc.suppliers = newTender.suppliers;\n                doc.createdAt = newTender.createdAt;\n                doc.history = newTender.history;\n                doc.save(function (err, newDoc) {\n                    if (err) {\n                        errorHandler(err);\n                    } else {\n                         console.log(newDoc);\n                    }\n                });\n            });\n\n\n        }\n    });\n}\n\nfunction updateTender(oldTender, newTender) {\n    const compareResults = compareTenders(oldTender, newTender);\n    if (Object.keys(compareResults).length !== 0) {\n        const tNewTender = {};\n        tNewTender._id = newTender._id;\n        tNewTender.name = newTender.name;\n        tNewTender.datePublished = newTender.datePublished;\n        tNewTender.startDate = newTender.startDate;\n        tNewTender.awardCriteria = newTender.awardCriteria;\n        tNewTender.tenderers = newTender.tenderers;\n        tNewTender.items = newTender.items;\n        tNewTender.classification_ids = newTender.classification_ids;\n        tNewTender.tenderID = newTender.tenderID;\n        tNewTender.title = newTender.title;\n        tNewTender.amount = newTender.amount;\n        tNewTender.currency = newTender.currency;\n        tNewTender.status = newTender.status;\n        tNewTender.suppliers = newTender.suppliers;\n        tNewTender.createdAt = oldTender.createdAt;\n        const date = new Date(Date.now());\n        const day = date.toLocaleDateString();\n        const time = date.toLocaleTimeString();\n        tNewTender.history = Object.assign(oldTender.history, {[`${day}:${time}`]: compareResults});\n        return tNewTender;\n    } else return oldTender;\n}\n\nexport function getTenderByID(tender, callback) {\n    Tender.find({_id: tender._id}).then(data => callback(data[0]));\n}\n\nexport function listAllTenders(callback) {\n    return Tender.find({}).then(data => callback(data));\n}\n\nexport function listTenders(tenderFilter, callback) {\n    Tender.find(tenderFilter).then(data => callback(data));\n}\n\nexport function setNextURI(URI) {\n    NextURI.findOne({_id: 'nextURI'}, (err, doc) => {\n        if (doc) {\n            doc.nextURI = URI;\n            doc.save((err, doc) => {\n                if (err) {\n                    errorHandler(err);\n                }\n            });\n\n        } else {\n            const uri = new NextURI;\n            uri._id = 'nextURI';\n            uri.nextURI = URI;\n            uri.save((err, doc) => {\n                if (err) {\n                    errorHandler(err);\n                }\n            });\n        }\n    })\n}\n\nexport function getNextURI(callback) {\n    NextURI.findOne({_id: 'nextURI'}, (err, doc) => {\n        if (doc) {\n            callback(doc.nextURI);\n        } else {\n            callback(false);\n        }\n    });\n}"]}