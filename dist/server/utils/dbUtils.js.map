{"version":3,"sources":["../../../server/utils/dbUtils.js"],"names":["connect","createTender","listTenders","setNextURI","getNextURI","Tender","mongoose","model","NextURI","db","config","host","port","name","tender","find","_id","then","data","length","console","log","newTender","datePublished","startDate","awardCriteria","tenderers","items","classification_ids","tenderID","title","amount","currency","status","suppliers","createdAt","Date","now","toLocaleDateString","toString","history","save","err","doc","updateTender","oldTender","tenderFilter","callback","URI","findOne","nextURI","uri"],"mappings":";;;;;QAWgBA,O,GAAAA,O;QAKAC,Y,GAAAA,Y;QAyCAC,W,GAAAA,W;QAIAC,U,GAAAA,U;QAuBAC,U,GAAAA,U;;AApFhB;;;;AACA;;;;AACA;;AACA;;AACA;;;;AACA;;;;;;;;AAEA,IAAMC,SAASC,mBAASC,KAAT,CAAe,QAAf,CAAf;AACA,IAAMC,UAAUF,mBAASC,KAAT,CAAe,SAAf,CAAhB;;AAGO,SAASP,OAAT,GAAmB;AACtB,QAAMS,KAAKC,iBAAOD,EAAlB;AACAH,uBAASN,OAAT,gBAA8BS,GAAGE,IAAjC,SAAyCF,GAAGG,IAA5C,SAAoDH,GAAGI,IAAvD;AACH;;AAEM,SAASZ,YAAT,CAAsBa,MAAtB,EAA8B;AACjCT,WAAOU,IAAP,CAAY,EAACC,KAAKF,OAAOE,GAAb,EAAZ,EAA+BC,IAA/B,CAAoC,gBAAQ;AACxC,YAAIC,KAAKC,MAAL,KAAgB,CAApB,EAAuB;AACnBC,oBAAQC,GAAR,CAAY,KAAZ;AACA,gBAAMC,YAAY,IAAIjB,MAAJ,EAAlB;AACAiB,sBAAUN,GAAV,GAAgBF,OAAOE,GAAvB;AACAM,sBAAUT,IAAV,GAAiBC,OAAOD,IAAxB;AACAS,sBAAUC,aAAV,GAA0BT,OAAOS,aAAjC;AACAD,sBAAUE,SAAV,GAAsBV,OAAOU,SAA7B;AACAF,sBAAUG,aAAV,GAA0BX,OAAOW,aAAjC;AACAH,sBAAUI,SAAV,GAAsBZ,OAAOY,SAA7B;AACAJ,sBAAUK,KAAV,GAAkBb,OAAOa,KAAzB;AACAL,sBAAUM,kBAAV,GAA+Bd,OAAOc,kBAAtC;AACAN,sBAAUO,QAAV,GAAqBf,OAAOe,QAA5B;AACAP,sBAAUQ,KAAV,GAAkBhB,OAAOgB,KAAzB;AACAR,sBAAUS,MAAV,GAAmBjB,OAAOiB,MAA1B;AACAT,sBAAUU,QAAV,GAAqBlB,OAAOkB,QAA5B;AACAV,sBAAUW,MAAV,GAAmBnB,OAAOmB,MAA1B;AACAX,sBAAUY,SAAV,GAAsBpB,OAAOoB,SAA7B;AACAZ,sBAAUa,SAAV,GAAsB,IAAIC,IAAJ,CAASA,KAAKC,GAAL,EAAT,EAAqBC,kBAArB,GAA0CC,QAA1C,EAAtB;AACAjB,sBAAUkB,OAAV,uBAAsB,IAAIJ,IAAJ,CAASA,KAAKC,GAAL,EAAT,EAAqBC,kBAArB,GAA0CC,QAA1C,EAAtB,EAA8E,aAA9E;AACAjB,sBAAUmB,IAAV,CAAe,UAAUC,GAAV,EAAeC,GAAf,EAAoB;AAC/B,oBAAID,GAAJ,EAAS;AACL,gDAAaA,GAAb;AACH,iBAFD,MAEO;AACJ;AACF;AACJ,aAND;AAOH,SA1BD,MA0BO;AACHE,yBAAa1B,KAAK,CAAL,CAAb,EAAsBJ,MAAtB;AACH;AACJ,KA9BD;AA+BH;;AAED,SAAS8B,YAAT,CAAsBC,SAAtB,EAAiCvB,SAAjC,EAA4C;AACxCF,YAAQC,GAAR,CAAY,SAAZ;AACAD,YAAQC,GAAR,CAAY,iCAAewB,SAAf,EAA0BvB,SAA1B,CAAZ;AACH;;AAIM,SAASpB,WAAT,CAAqB4C,YAArB,EAAmCC,QAAnC,EAA6C;AAChD1C,WAAOU,IAAP,CAAY+B,YAAZ,EAA0B7B,IAA1B,CAA+B;AAAA,eAAQ8B,SAAS7B,IAAT,CAAR;AAAA,KAA/B;AACH;;AAEM,SAASf,UAAT,CAAoB6C,GAApB,EAAyB;AAC5BxC,YAAQyC,OAAR,CAAgB,EAACjC,KAAK,SAAN,EAAhB,EAAkC,UAAC0B,GAAD,EAAMC,GAAN,EAAc;AAC5C,YAAIA,GAAJ,EAAS;AACLA,gBAAIO,OAAJ,GAAcF,GAAd;AACAL,gBAAIF,IAAJ,CAAS,UAACC,GAAD,EAAMC,GAAN,EAAc;AACnB,oBAAGD,GAAH,EAAO;AACH,gDAAaA,GAAb;AACH;AACJ,aAJD;AAMH,SARD,MAQO;AACH,gBAAMS,MAAM,IAAI3C,OAAJ,EAAZ;AACA2C,gBAAInC,GAAJ,GAAU,SAAV;AACAmC,gBAAID,OAAJ,GAAcF,GAAd;AACAG,gBAAIV,IAAJ,CAAS,UAACC,GAAD,EAAMC,GAAN,EAAc;AACnB,oBAAGD,GAAH,EAAO;AACH,gDAAaA,GAAb;AACH;AACJ,aAJD;AAKH;AACJ,KAnBD;AAoBH;;AAEM,SAAStC,UAAT,CAAoB2C,QAApB,EAA8B;AACjCvC,YAAQyC,OAAR,CAAgB,EAACjC,KAAK,SAAN,EAAhB,EAAkC,UAAC0B,GAAD,EAAMC,GAAN,EAAc;AAC5C,YAAIA,GAAJ,EAAS;AACNI,qBAASJ,IAAIO,OAAb;AAEF,SAHD,MAGO;AACHH,qBAAS,KAAT;AACH;AACJ,KAPD;AAQH","file":"dbUtils.js","sourcesContent":["import mongoose from 'mongoose';\nimport config from '../config/config.js';\nimport '../models/Tender';\nimport '../models/NextURI';\nimport errorHandler from '../errorHandler';\nimport compareTenders from './tendersComparator';\n\nconst Tender = mongoose.model('Tender');\nconst NextURI = mongoose.model('NextURI');\n\n\nexport function connect() {\n    const db = config.db;\n    mongoose.connect(`mongodb://${db.host}:${db.port}/${db.name}`);\n}\n\nexport function createTender(tender) {\n    Tender.find({_id: tender._id}).then(data => {\n        if (data.length === 0) {\n            console.log('NEW');\n            const newTender = new Tender;\n            newTender._id = tender._id;\n            newTender.name = tender.name;\n            newTender.datePublished = tender.datePublished;\n            newTender.startDate = tender.startDate;\n            newTender.awardCriteria = tender.awardCriteria;\n            newTender.tenderers = tender.tenderers;\n            newTender.items = tender.items;\n            newTender.classification_ids = tender.classification_ids;\n            newTender.tenderID = tender.tenderID;\n            newTender.title = tender.title;\n            newTender.amount = tender.amount;\n            newTender.currency = tender.currency;\n            newTender.status = tender.status;\n            newTender.suppliers = tender.suppliers;\n            newTender.createdAt = new Date(Date.now()).toLocaleDateString().toString();\n            newTender.history = {[new Date(Date.now()).toLocaleDateString().toString()] : 'Added to DB'};\n            newTender.save(function (err, doc) {\n                if (err) {\n                    errorHandler(err);\n                } else {\n                   // console.log(doc);\n                }\n            });\n        } else {\n            updateTender(data[0], tender);\n        }\n    });\n}\n\nfunction updateTender(oldTender, newTender) {\n    console.log('UPDATE!');\n    console.log(compareTenders(oldTender, newTender));\n}\n\n\n\nexport function listTenders(tenderFilter, callback) {\n    Tender.find(tenderFilter).then(data => callback(data));\n}\n\nexport function setNextURI(URI) {\n    NextURI.findOne({_id: 'nextURI'}, (err, doc) => {\n        if (doc) {\n            doc.nextURI = URI;\n            doc.save((err, doc) => {\n                if(err){\n                    errorHandler(err);\n                }\n            });\n\n        } else {\n            const uri = new NextURI;\n            uri._id = 'nextURI';\n            uri.nextURI = URI;\n            uri.save((err, doc) => {\n                if(err){\n                    errorHandler(err);\n                }\n            });\n        }\n    })\n}\n\nexport function getNextURI(callback) {\n    NextURI.findOne({_id: 'nextURI'}, (err, doc) => {\n        if (doc) {\n           callback(doc.nextURI);\n\n        } else {\n            callback(false);\n        }\n    });\n}"]}