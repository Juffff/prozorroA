{"version":3,"sources":["../../server/app.js"],"names":["db","JSDOM","jsdom","connect","corsOptions","origin","optionsSuccessStatus","app","use","bodyParser","json","startUri","apiPrefix","get","req","res","goThrowTenders","sendStatus","uri","https","require","str","on","chunk","resJson","JSON","parse","nextUri","next_page","data","length","map","id","forEach","analizeToTender","prefix","then","body","allInfo","questions","complaints","tender","_id","auctionPeriod","startDate","awardCriteria","bids","Array","isArray","tenderers","bid","name","replace","items","item","classification","description","classification_ids","tenderID","title","amount","value","currency","valueAddedTaxIncluded","Number","parseInt","a","itemIdEnum","indexOf","console","log","listen"],"mappings":";;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;IAAYA,E;;AACZ;;;;AACA;;;;AACA;;;;AACA;;;;;;;;IANOC,K,GAASC,e,CAATD,K;;;AASPD,GAAGG,OAAH;AACA,IAAMC,cAAc;AAChBC,YAAQ,GADQ;AAEhBC,0BAAsB,GAFN,CAEW;AAFX,CAApB;;AAMA,IAAMC,MAAM,wBAAZ;AACAA,IAAIC,GAAJ,CAAQC,qBAAWC,IAAX,EAAR;AACAH,IAAIC,GAAJ,CAAQ,oBAAKJ,WAAL,CAAR;AACA,IAAIO,WAAW,uEAAf;AACA,IAAMC,YAAY,yDAAlB;;AAEAL,IAAIM,GAAJ,CAAQ,GAAR,EAAa,UAACC,GAAD,EAAMC,GAAN,EAAc;;AAEvBC,mBAAeL,QAAf;;AAEAI,QAAIE,UAAJ,CAAe,GAAf;AACH,CALD;;AAOA,SAASD,cAAT,CAAwBE,GAAxB,EAA6B;AACzB,QAAMC,QAAQC,QAAQ,OAAR,CAAd;AACAD,UAAMN,GAAN,CAAUK,GAAV,EAAe,UAASH,GAAT,EAAa;AACxB,YAAIM,MAAM,EAAV;AACAN,YAAIO,EAAJ,CAAO,MAAP,EAAe,UAAUC,KAAV,EAAiB;AAC5BF,mBAAOE,KAAP;AACH,SAFD;AAGAR,YAAIO,EAAJ,CAAO,KAAP,EAAc,YAAY;AACtB,gBAAME,UAAUC,KAAKC,KAAL,CAAWL,GAAX,CAAhB;AACA,gBAAMM,UAAUH,QAAQI,SAAR,CAAkBV,GAAlC;AACA,gBAAMW,OAAOL,QAAQK,IAArB;AACA,gBAAGA,KAAKC,MAAL,KAAgB,CAAnB,EAAqB;AACjB;AACH,aAFD,MAEO;AACHN,wBAAQK,IAAR,CAAaE,GAAb,CAAiB;AAAA,2BAAQF,KAAKG,EAAb;AAAA,iBAAjB,EAAkCC,OAAlC,CAA0C,cAAM;AAC5CC,oCAAgBtB,SAAhB,EAA2BoB,EAA3B;AACH,iBAFD;AAGAhB,+BAAeW,OAAf;AACH;AACJ,SAZD;AAaH,KAlBD;AAmBH;;AAED,SAASO,eAAT,CAAyBC,MAAzB,EAAiCH,EAAjC,EAAqC;AACjC,4BAAOG,MAAP,GAAgBH,EAAhB,EAAsBI,IAAtB,CAA2B,gBAAQ;AAC/B,YAAGP,KAAKQ,IAAR,EAAa;AACT,gBAAMC,UAAUb,KAAKC,KAAL,CAAWG,KAAKQ,IAAhB,EAAsBR,IAAtC;AACA,gBAAGS,OAAH,EAAW;AACP,uBAAOA,QAAQC,SAAf;AACA,uBAAOD,QAAQE,UAAf;AACA,oBAAMC,SAAS,EAAf;AACAA,uBAAOC,GAAP,GAAaJ,QAAQN,EAArB;AACA,oBAAGM,QAAQK,aAAX,EAAyB;AACrBF,2BAAOG,SAAP,GAAmBN,QAAQK,aAAR,CAAsBC,SAAzC;AACH;AACDH,uBAAOI,aAAP,GAAuBP,QAAQO,aAA/B;AACA,oBAAGP,QAAQQ,IAAX,EAAgB;AACZ,wBAAGC,MAAMC,OAAN,CAAcV,QAAQQ,IAAtB,CAAH,EAA+B;AAC3B,4BAAGR,QAAQQ,IAAR,CAAa,CAAb,CAAH,EAAmB;AACfL,mCAAOQ,SAAP,GAAmBX,QAAQQ,IAAR,CAAaf,GAAb,CAAiB;AAAA,uCAAOmB,IAAID,SAAJ,CAAc,CAAd,EAAiBE,IAAjB,CAAsBC,OAAtB,CAA8B,yCAA9B,EAAyE,KAAzE,EAAgFA,OAAhF,CAAwF,GAAxF,EAA4F,IAA5F,EAAkGA,OAAlG,CAA0G,GAA1G,EAA8G,IAA9G,CAAP;AAAA,6BAAjB,CAAnB;AACH;AACJ;AACJ;AACDX,uBAAOY,KAAP,GAAef,QAAQe,KAAR,CAActB,GAAd,CAAkB;AAAA,2BAAQuB,KAAKC,cAAL,CAAoBC,WAA5B;AAAA,iBAAlB,CAAf;AACAf,uBAAOgB,kBAAP,GAA4BnB,QAAQe,KAAR,CAActB,GAAd,CAAkB;AAAA,2BAAQuB,KAAKC,cAAL,CAAoBvB,EAA5B;AAAA,iBAAlB,CAA5B;AACAS,uBAAOiB,QAAP,GAAkBpB,QAAQoB,QAA1B;AACAjB,uBAAOkB,KAAP,GAAerB,QAAQqB,KAAvB;AACAlB,uBAAOmB,MAAP,GAAgBtB,QAAQuB,KAAR,CAAcD,MAA9B;AACAnB,uBAAOqB,QAAP,GAAkBxB,QAAQuB,KAAR,CAAcC,QAAhC;AACArB,uBAAOsB,qBAAP,GAA+BzB,QAAQuB,KAAR,CAAcE,qBAA7C;AACA,oBAAGC,OAAOC,QAAP,CAAgBxB,OAAOmB,MAAvB,EAA+B,EAA/B,IAAmC,OAAtC,EAA8C;AAC1C,wBAAIM,IAAI,KAAR;AACA,wBAAGzB,OAAOgB,kBAAV,EAA6B;AACzB,4BAAGV,MAAMC,OAAN,CAAcP,OAAOgB,kBAArB,CAAH,EAA4C;AACxChB,mCAAOgB,kBAAP,CAA0BxB,OAA1B,CAAkC,cAAM;AACpC,oCAAGkC,kBAAWC,OAAX,CAAmBpC,EAAnB,IAAyB,CAAC,CAA7B,EAA+B;AAC3BqC,4CAAQC,GAAR,CAAY7B,MAAZ;AACH;AACJ,6BAJD;AAKH;AACJ;AAEJ;AACD;AACH;AACJ;AACJ,KA1CD;AA2CH;;AAGDlC,IAAIgE,MAAJ,CAAW,IAAX,EAAiB,YAAM;AACnBF,YAAQC,GAAR;AACH,CAFD","file":"app.js","sourcesContent":["import express from 'express';\nimport bodyParser from 'body-parser';\nimport cors from 'cors';\nimport got from 'got';\nimport jsdom from 'jsdom';\nconst {JSDOM} = jsdom;\nimport replaceAll from 'replaceall';\nimport * as db from './utils/dbutils';\nimport utf8 from 'utf8';\nimport util from 'util';\nimport itemIdEnum from './enums/item_id';\nimport XMLHttpRequest from 'xmlhttprequest';\n\n\ndb.connect();\nconst corsOptions = {\n    origin: '*',\n    optionsSuccessStatus: 200, // some legacy browsers (IE11, various SmartTVs) choke on 204\n};\n\n\nconst app = express();\napp.use(bodyParser.json());\napp.use(cors(corsOptions));\nlet startUri = 'https://public.api.openprocurement.org/api/2.4/tenders?offset=2018-05';\nconst apiPrefix = 'https://public.api.openprocurement.org/api/2.4/tenders/';\n\napp.get('/', (req, res) => {\n\n    goThrowTenders(startUri);\n\n    res.sendStatus(200);\n});\n\nfunction goThrowTenders(uri) {\n    const https = require('https');\n    https.get(uri, function(res){\n        let str = '';\n        res.on('data', function (chunk) {\n            str += chunk;\n        });\n        res.on('end', function () {\n            const resJson = JSON.parse(str);\n            const nextUri = resJson.next_page.uri;\n            const data = resJson.data;\n            if(data.length === 0){\n                return;\n            } else {\n                resJson.data.map(data => data.id).forEach(id => {\n                    analizeToTender(apiPrefix, id);\n                });\n                goThrowTenders(nextUri);\n            }\n        });\n    });\n}\n\nfunction analizeToTender(prefix, id) {\n    got(`${prefix}${id}`).then(data => {\n        if(data.body){\n            const allInfo = JSON.parse(data.body).data;\n            if(allInfo){\n                delete allInfo.questions;\n                delete allInfo.complaints;\n                const tender = {};\n                tender._id = allInfo.id;\n                if(allInfo.auctionPeriod){\n                    tender.startDate = allInfo.auctionPeriod.startDate;\n                }\n                tender.awardCriteria = allInfo.awardCriteria;\n                if(allInfo.bids){\n                    if(Array.isArray(allInfo.bids)){\n                        if(allInfo.bids[0]){\n                            tender.tenderers = allInfo.bids.map(bid => bid.tenderers[0].name.replace('ТОВАРИСТВО З ОБМЕЖЕНОЮ ВІДПОВІДАЛЬНІСТЮ', 'ТОВ').replace('«','\\\"').replace('»','\\\"'));\n                        }\n                    }\n                }\n                tender.items = allInfo.items.map(item => item.classification.description);\n                tender.classification_ids = allInfo.items.map(item => item.classification.id);\n                tender.tenderID = allInfo.tenderID;\n                tender.title = allInfo.title;\n                tender.amount = allInfo.value.amount;\n                tender.currency = allInfo.value.currency;\n                tender.valueAddedTaxIncluded = allInfo.value.valueAddedTaxIncluded;\n                if(Number.parseInt(tender.amount, 10)>1000000){\n                    let a = false;\n                    if(tender.classification_ids){\n                        if(Array.isArray(tender.classification_ids)){\n                            tender.classification_ids.forEach(id => {\n                                if(itemIdEnum.indexOf(id) > -1){\n                                    console.log(tender);\n                                };\n                            });\n                        }\n                    }\n\n                }\n                //db.createTender(tender);\n            }\n        }\n    });\n}\n\n\napp.listen(8080, () => {\n    console.log(`Server is running on 8070`);\n});\n\n\n\n"]}