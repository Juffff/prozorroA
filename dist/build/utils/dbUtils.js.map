{"version":3,"sources":["../../../build/utils/dbUtils.js"],"names":["Object","defineProperty","exports","value","connect","createTender","getTenderByID","listAllTenders","listTenders","setNextURI","getNextURI","_mongoose","require","_mongoose2","_interopRequireDefault","_config","_config2","_errorHandler","_errorHandler2","_tendersComparator","_tendersComparator2","obj","__esModule","default","_defineProperty","key","enumerable","configurable","writable","Tender","model","NextURI","db","Promise","global","host","port","name","useMongoClient","tender","find","_id","then","data","length","newTender","datePublished","startDate","awardCriteria","tenderers","items","classification_ids","tenderID","title","amount","currency","status","suppliers","createdAt","Date","now","toLocaleDateString","toString","date","day","time","toLocaleTimeString","history","save","err","doc","findOne","updateTender","newDoc","console","log","oldTender","compareResults","keys","tNewTender","assign","callback","tenderFilter","URI","nextURI","uri"],"mappings":"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","file":"dbUtils.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.connect = connect;\nexports.createTender = createTender;\nexports.getTenderByID = getTenderByID;\nexports.listAllTenders = listAllTenders;\nexports.listTenders = listTenders;\nexports.setNextURI = setNextURI;\nexports.getNextURI = getNextURI;\n\nvar _mongoose = require('mongoose');\n\nvar _mongoose2 = _interopRequireDefault(_mongoose);\n\nvar _config = require('../config/config.js');\n\nvar _config2 = _interopRequireDefault(_config);\n\nrequire('../models/Tender');\n\nrequire('../models/NextURI');\n\nvar _errorHandler = require('../errorHandler');\n\nvar _errorHandler2 = _interopRequireDefault(_errorHandler);\n\nvar _tendersComparator = require('./tendersComparator');\n\nvar _tendersComparator2 = _interopRequireDefault(_tendersComparator);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nvar Tender = _mongoose2.default.model('Tender');\nvar NextURI = _mongoose2.default.model('NextURI');\n\nfunction connect() {\n    var db = _config2.default.db;\n    _mongoose2.default.Promise = global.Promise;\n    _mongoose2.default.connect('mongodb://' + db.host + ':' + db.port + '/' + db.name, { useMongoClient: true });\n    //mongoose.set('debug', true);\n}\n\nfunction createTender(tender) {\n    Tender.find({ _id: tender._id }).then(function (data) {\n        if (data.length === 0) {\n            var newTender = new Tender();\n            newTender._id = tender._id;\n            newTender.name = tender.name;\n            newTender.datePublished = tender.datePublished;\n            newTender.startDate = tender.startDate;\n            newTender.awardCriteria = tender.awardCriteria;\n            newTender.tenderers = tender.tenderers;\n            newTender.items = tender.items;\n            newTender.classification_ids = tender.classification_ids;\n            newTender.tenderID = tender.tenderID;\n            newTender.title = tender.title;\n            newTender.amount = tender.amount;\n            newTender.currency = tender.currency;\n            newTender.status = tender.status;\n            newTender.suppliers = tender.suppliers;\n            newTender.createdAt = new Date(Date.now()).toLocaleDateString().toString();\n            var date = new Date(Date.now());\n            var day = date.toLocaleDateString();\n            var time = date.toLocaleTimeString();\n            if (!tender.history) {\n                newTender.history = _defineProperty({}, day + ':' + time, 'Тендер добавлен в базу');\n            } else newTender.history = tender.history;\n            newTender.save(function (err, doc) {\n                if (err) {\n                    (0, _errorHandler2.default)(err);\n                } else {\n                    // console.log(doc);\n                }\n            });\n        } else {\n            Tender.findOne({ _id: tender._id }, function (err, doc) {\n                var newTender = updateTender(data[0], tender);\n                doc._id = newTender._id;\n                doc.name = newTender.name;\n                doc.datePublished = newTender.datePublished;\n                doc.startDate = newTender.startDate;\n                doc.awardCriteria = newTender.awardCriteria;\n                doc.tenderers = newTender.tenderers;\n                doc.items = newTender.items;\n                doc.classification_ids = newTender.classification_ids;\n                doc.tenderID = newTender.tenderID;\n                doc.title = newTender.title;\n                doc.amount = newTender.amount;\n                doc.currency = newTender.currency;\n                doc.status = newTender.status;\n                doc.suppliers = newTender.suppliers;\n                doc.createdAt = newTender.createdAt;\n                doc.history = newTender.history;\n                doc.save(function (err, newDoc) {\n                    if (err) {\n                        (0, _errorHandler2.default)(err);\n                    } else {\n                        console.log(newDoc);\n                    }\n                });\n            });\n        }\n    });\n}\n\nfunction updateTender(oldTender, newTender) {\n    var compareResults = (0, _tendersComparator2.default)(oldTender, newTender);\n    if (Object.keys(compareResults).length !== 0) {\n        var tNewTender = {};\n        tNewTender._id = newTender._id;\n        tNewTender.name = newTender.name;\n        tNewTender.datePublished = newTender.datePublished;\n        tNewTender.startDate = newTender.startDate;\n        tNewTender.awardCriteria = newTender.awardCriteria;\n        tNewTender.tenderers = newTender.tenderers;\n        tNewTender.items = newTender.items;\n        tNewTender.classification_ids = newTender.classification_ids;\n        tNewTender.tenderID = newTender.tenderID;\n        tNewTender.title = newTender.title;\n        tNewTender.amount = newTender.amount;\n        tNewTender.currency = newTender.currency;\n        tNewTender.status = newTender.status;\n        tNewTender.suppliers = newTender.suppliers;\n        tNewTender.createdAt = oldTender.createdAt;\n        var date = new Date(Date.now());\n        var day = date.toLocaleDateString();\n        var time = date.toLocaleTimeString();\n        tNewTender.history = Object.assign(oldTender.history, _defineProperty({}, day + ':' + time, compareResults));\n        return tNewTender;\n    } else return oldTender;\n}\n\nfunction getTenderByID(tender, callback) {\n    Tender.find({ _id: tender._id }).then(function (data) {\n        return callback(data[0]);\n    });\n}\n\nfunction listAllTenders(callback) {\n    return Tender.find({}).then(function (data) {\n        return callback(data);\n    });\n}\n\nfunction listTenders(tenderFilter, callback) {\n    Tender.find(tenderFilter).then(function (data) {\n        return callback(data);\n    });\n}\n\nfunction setNextURI(URI) {\n    NextURI.findOne({ _id: 'nextURI' }, function (err, doc) {\n        if (doc) {\n            doc.nextURI = URI;\n            doc.save(function (err, doc) {\n                if (err) {\n                    (0, _errorHandler2.default)(err);\n                }\n            });\n        } else {\n            var uri = new NextURI();\n            uri._id = 'nextURI';\n            uri.nextURI = URI;\n            uri.save(function (err, doc) {\n                if (err) {\n                    (0, _errorHandler2.default)(err);\n                }\n            });\n        }\n    });\n}\n\nfunction getNextURI(callback) {\n    NextURI.findOne({ _id: 'nextURI' }, function (err, doc) {\n        if (doc) {\n            callback(doc.nextURI);\n        } else {\n            callback(false);\n        }\n    });\n}"]}